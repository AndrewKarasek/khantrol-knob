// the semi-colon before function invocation is a safety net against concatenated
// scripts and/or other plugins which may not be closed properly.
(function(e,t,n,r){function o(t,n){this.element=t;this.settings=e.extend({},s,n);this._name=i;this._defaults=s;this.init();this.behaviour()}var i="khantrolKnob",s={startingPos:-135,range:230,moveBy:.1,minVal:0,maxVal:100,speed:20,holdKey:!1,groupKey:!1,alsoTurn:!1,placeInner:".nu",innerHTML:"",focusMode:!0,progressMode:"false",progressGap:10,progressWidth:15,scaleExt:5,scaleBase:3,extraHTML:""};o.prototype={init:function(){var t=e(this.element),n=this.settings.range,r=n/2;n===Infinity&&(r=0);var i=this.settings.outerHTML;t.wrap("<div class='khantrol-knob'>");var s=t.parent();s.prepend("<div class='kk-knobWrap'><div class='kk-faceWrap'><div class='kk-movingFace'><div class='kk-hand'></div><div class='kk-center'></div></div></div><canvas class='kk-progress'></canvas></div>");this.settings.extraHTML!==""&&s.prepend(this.settings.extraHTML);var o=s.find(".kk-faceWrap"),u=o.find(".kk-movingFace"),a=u.find(".kk-hand"),f=o.find(".kk-center"),l={};s.append("<div class='on-light'></div>").append("<span class='khanknob-value'>0</span>").css("height","auto").css("width","auto");u.css("position","relative").css("overflow","hidden").css("float","none").css("-webkit-transform","rotate("+ -r+"deg)").data("degs",-r).data("value",0).data("md",!1).css("z-index","29");o.css("float","none");l=s.find(".kk-progress");l.css("position","absolute").css("top",0).css("left",0).css("z-index","0");var c=this.settings.progressWidth+this.settings.progressGap;this.settings.progressMode==="scale"&&(c+=this.settings.scaleExt);if(this.settings.progressMode==="bar"||this.settings.progressMode==="scale"){o.css("padding",c);s.css("padding",c)}this.settings.progressMode==="scale";var h=u.innerWidth()/2-a.width()/2,p=u.innerWidth()/2-f.width()/2;a.css("position","absolute").css("left",h).css("height",u.height()/2);f.css("position","absolute").css("left",p).css("top",p);t.attr("value",0)},behaviour:function(){function N(e){var t=e*(Math.PI/180);return t}function C(e){e+=270;return e}function k(t){var n=r.find("canvas").get(0);n.height=e(n).parent().height();n.width=e(n).parent().width();var i=n.getContext("2d");i.clearRect(0,0,n.width,n.height);pos=e(n).width()/2;var s=pos,o=pos,u=d,a=N(C(-x)),f=N(t),l=!1;i.beginPath();i.arc(s,o,u,a,f,!1);i.lineWidth=g;i.strokeStyle="rgb(30,30,30)";i.stroke()}function L(){var t=r.find("canvas").get(0);t.height=e(t).parent().height();t.width=e(t).parent().width();var n=t.getContext("2d");n.clearRect(0,0,t.width,t.height);pos=e(t).width()/2;var i=pos,s=pos,o=d,u=N(C(-x-.6)),a,c=!1,h=x*-1;for(var p=0;p<=100;p++){n.beginPath();if(p==0||p%10==0){n.lineWidth=g+v;n.arc(i,s,o+v/2,N(C(h-.6)),N(C(h+.6)),!1)}else if(p%5==0){n.lineWidth=g+v/2;n.arc(i,s,o+v/4,N(C(h-.6)),N(C(h+.6)),!1)}else{n.lineWidth=g;n.arc(i,s,o,N(C(h-.5)),N(C(h+.5)),!1)}n.strokeStyle="white";n.stroke();n.closePath();var y=f/100;h+=y}var b=m,w=o-g/2,E=w+b/2-1;n.beginPath();n.lineWidth=b;n.arc(i,s,E,u,N(C(l+.6)),!1);n.strokeStyle="white";n.stroke()}function A(){var e=r.find("canvas").get(0),t=e.getContext("2d");t.clearRect(0,0,0,1)}function O(e,t){s.clickpos=t.pageY||t.originalEvent.targetTouches[0].pageY;s.focus=e;e.data("md",!0)}function M(e,n,r,u){if(s.focus.data("md")||n||r){o+=.3;if(!n&&!r)var a=e.pageY||e.originalEvent.targetTouches[0].pageY;u&&(o=7);var f=s.focus;if(n||r)f=i;var h=f.data("degs");if(s.clickpos<a||n)if(a<y){P();h+o<l?h+=o:h=l}else h-o>c?h-=o:h=c;else if(s.clickpos>a||r)if(a>y){P();h-o>c?h-=o:h=c}else h+o<l?h+=o:h=l;h>c?t.parent().addClass("turned-on"):t.parent().removeClass("turned-on");f.data("degs",h).css("-webkit-transform","rotate("+h+"deg)");var d=f.data("degs")+l,v=Math.round(d/S);f.data("value",v);f.trigger("change");f.parent().find(".khantrolKnob").trigger("change");p==="bar"&&k(C(h));!n&&!r&&(y=e.pageY||e.originalEvent.targetTouches[0].pageY);e.preventDefault()}}function _(e){var t=e.parent().parent();t.css("position","fixed").css("background-color","rgba(0,0,0,0.85)").css("height","200%").css("width","100%").css("top",0).css("left",0).css("z-index",999999)}function D(){s.focus.data("md",!1);P()}function P(){o=.1}function H(e){s.holdKey=!0;i.parent().parent().parent().addClass("holding")}function B(){s.groupKey=!0;i.parent().parent().parent().addClass("holding")}function j(){s.groupKey=!1;i.parent().parent().parent().removeClass("holding")}function F(){s.holdKey=!1;i.parent().parent().parent().removeClass("holding")}function I(e){(s.holdKey===!0||s.groupKey)&&M(e,!1,!0)}function q(e){(s.holdKey===!0||s.groupKey)&&M(e,!0,!1)}function h(){alert(1)}var t=e(this.element),r=t.parent();console.log(r);var i=r.find(".kk-movingFace"),s={},o=this.settings.moveBy,u=this.settings.holdKey,a=this.settings.groupKey,f=this.settings.range,l=f/2,c=l*-1,h=this.settings.focusMode,p=this.settings.progressMode,d=this.settings.progressGap+i.width()/2,v=this.settings.scaleExt,m=this.settings.scaleBase,g=this.settings.progressWidth,y=0,b=this.settings.minVal,w=this.settings.maxVal,E=w-b,S=f/E,x=this.settings.range/2;s.clickpos=0;s.focus=t;s.holdKey=!1;s.groupKey=!1;var T=this.settings.speed;this.settings.progressMode==="scale"?L():A();i.on("touchstart",function(t){O(e(this),t)});e(n).on("touchmove",function(e){M(e,!1,!1,!0)});e(n).on("touchend",function(e){D()});i.on("mousedown",function(t){O(e(this),t)});e(n).on("mousemove",function(e){M(e,!1,!1)});e(n).on("mouseup",function(){D()});e(n).on("keydown",function(e){var t=e.keyCode||e.which;t===38?I(e):t===40&&q(e);if(t===u){H();e.preventDefault()}if(t===a){B();e.preventDefault()}});e(n).on("keyup",function(e){var t=e.keyCode||e.which;if(t===u){F();P()}if(t===a){j();P()}(t===38||t===40)&&P()});i.on("change",function(){var n=e(this).data("value");t.attr("value",n);e(this).parent().parent().find(".khanknob-value").html(n)})}};e.fn[i]=function(t){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new o(this,t))})}})(jQuery,window,document);