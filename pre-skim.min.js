// the semi-colon before function invocation is a safety net against concatenated
// scripts and/or other plugins which may not be closed properly.
(function(e,t,n,r){function o(t,n){this.element=t;this.settings=e.extend({},s,n);this._name=i;this._defaults=s;this.init();this.behaviour()}var i="khantrolKnob",s={startingPos:-135,range:270,css:"default",responsive:!1,moveBy:.1,minVal:0,maxVal:100,speed:20,holdKey:!1,groupKey:!1,alsoTurn:!1,placeInner:".nu",innerHTML:"",focusMode:!0,progressMode:"false",progressGap:10,progressWidth:15,scaleExt:5,scaleBase:3,extraHTML:""};o.prototype={init:function(){var n=e(this.element),r=this.settings.range,i=r/2,s=this.settings.css,o=this.settings.responsive;r===Infinity&&(i=0);var u=this.settings.outerHTML;n.wrap("<div class='khantrol-knob kk-"+s+"'>");var a=n.parent();a.prepend("<div class='kk-face'><div class='kk-movingFace'><div class='kk-hand'></div></div></div><canvas class='kk-progress'></canvas>");this.settings.extraHTML!==""&&a.prepend(this.settings.extraHTML);var f=a.find(".kk-face"),l=f.find(".kk-movingFace"),c=l.find(".kk-hand"),h={};a.append("<span class='kk-value'>"+this.settings.minVal+"</span>");l.css("position","relative").css("overflow","hidden").css("float","none").css("-webkit-transform","rotate("+ -i+"deg)").css("-moz-transform","rotate("+ -i+"deg)").css("-ms-transform","rotate("+ -i+"deg)").css("-o-transform","rotate("+ -i+"deg)").css("transform","rotate("+ -i+"deg)").data("degs",-i).data("value",0).data("md",!1).css("z-index","29");f.css("float","none");h=a.find(".kk-progress");h.css("position","absolute").css("top",0).css("left",0).css("z-index","0");if(this.settings.responsive){a.addClass("kk-fluid");a.find(".kk-face").css("height",a.find(".kk-face").width())}var p=l.innerWidth()/2-c.width()/2;c.css("position","absolute").css("left",p).css("height",l.height()/2);e(t).resize(function(){if(o){var e=l.innerWidth()/2-c.width()/2;a.find(".kk-face").css("height",a.find(".kk-face").width());c.css("left",e).css("height",l.height()/2)}});n.attr("value",this.settings.minVal)},behaviour:function(){function k(e){var t=e*(Math.PI/180);return t}function L(e){e+=270;return e}function A(){var e=r.find("canvas").get(0),t=e.getContext("2d");t.clearRect(0,0,0,1)}function O(e,t){s.clickpos=t.pageY||t.originalEvent.targetTouches[0].pageY;s.focus=e;e.data("md",!0)}function M(e,n,r,u){if(s.focus.data("md")||n||r){if(!n&&!r){var a=e.pageY||e.originalEvent.targetTouches[0].pageY;console.log("mouse moved")}u&&(o=7);var f=s.focus;if(n||r)f=i;var h=f.data("degs");if(s.clickpos<a||n)if(a<b){console.log("CHANGED D, down now up");h+o<l||(h=l)}else if(h-o>c){var p=s.clickpos-a;console.log(p);h=p*N-T}else h=c;else if(s.clickpos>a||r)if(a>b)h-o>c||(h=c);else if(h+o<l){var p=s.clickpos-a;console.log(p);h=p*N-T}else h=l;h>c?t.parent().addClass("turned-on"):t.parent().removeClass("turned-on");f.data("degs",h).css("-webkit-transform","rotate("+h+"deg)").css("-moz-transform","rotate("+h+"deg)").css("-ms-transform","rotate("+h+"deg)").css("-o-transform","rotate("+h+"deg)").css("transform","rotate("+h+"deg)");var v=f.data("degs")+l,m=Math.round(v/x);f.data("value",m);f.trigger("change");f.parent().find(".khantrolKnob").trigger("change");d==="bar"&&progArc(L(h));!n&&!r&&(b=e.pageY||e.originalEvent.targetTouches[0].pageY);e.preventDefault()}}function _(){s.focus.data("md",!1);D()}function D(){o=.1}function P(e){s.holdKey=!0;i.parent().parent().addClass("holding")}function H(){s.groupKey=!0;i.parent().parent().addClass("holding")}function B(){s.groupKey=!1;i.parent().parent().removeClass("holding")}function j(){s.holdKey=!1;i.parent().parent().removeClass("holding")}function F(e){(s.holdKey===!0||s.groupKey)&&M(e,!1,!0)}function I(e){(s.holdKey===!0||s.groupKey)&&M(e,!0,!1)}var t=e(this.element),r=t.parent(),i=r.find(".kk-movingFace"),s={},o=this.settings.moveBy,u=this.settings.holdKey,a=this.settings.groupKey,f=this.settings.range,l=f/2,c=l*-1,h=this.settings.focusMode,p=this.settings.responsive,d=this.settings.progressMode,v=this.settings.progressGap+i.width()/2,m=this.settings.scaleExt,g=this.settings.scaleBase,y=this.settings.progressWidth,b=0,w=this.settings.minVal,E=this.settings.maxVal,S=E-w,x=f/S,T=this.settings.range/2,N=this.settings.range/(this.settings.maxVal-this.settings.minVal);s.clickpos=0;s.focus=t;s.holdKey=!1;s.groupKey=!1;var C=this.settings.speed;i.on("touchstart",function(t){O(e(this),t)});e(n).on("touchmove",function(e){M(e,!1,!1,!0)});e(n).on("touchend",function(e){_()});i.on("mousedown",function(t){O(e(this),t)});e(n).on("mousemove",function(e){M(e,!1,!1)});e(n).on("mouseup",function(){_()});e(n).on("keydown",function(e){var t=e.keyCode||e.which;t===38?F(e):t===40&&I(e);if(t===u){P();e.preventDefault()}if(t===a){H();e.preventDefault()}});e(n).on("keyup",function(e){var t=e.keyCode||e.which;if(t===u){j();D()}if(t===a){B();D()}(t===38||t===40)&&D()});i.on("change",function(n){var r=e(this).data("value");t.attr("value",r);e(this).parent().parent().find(".kk-value").html(r);t.trigger("change")})}};e.fn[i]=function(t){return this.each(function(){e.data(this,"plugin_"+i)||e.data(this,"plugin_"+i,new o(this,t))})}})(jQuery,window,document);